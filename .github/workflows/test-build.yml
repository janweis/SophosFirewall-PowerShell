name: Test & Build

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Modules/**'
      - 'Tests/**'
      - '.github/workflows/**'
      - '*.ps1'
      - '*.md'
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  pester-test:
    name: Pester Tests
    runs-on: windows-latest
    
    strategy:
      matrix:
        powershell-version: ['5.1', 'latest']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up PowerShell ${{ matrix.powershell-version }}
        uses: actions/setup-pwsh@v2
        with:
          pwsh-version: ${{ matrix.powershell-version }}
      
      - name: Install Pester module
        shell: pwsh
        run: |
          Install-Module -Name Pester -MinimumVersion 5.0 -Force -SkipPublisherCheck
      
      - name: Run Pester Tests
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Continue'
          $testFiles = Get-ChildItem -Path 'Tests' -Recurse -Filter '*.Tests.ps1' -ErrorAction SilentlyContinue
          
          if ($testFiles) {
            $testResults = Invoke-Pester -Path $testFiles.FullName -PassThru -OutputFormat NUnitXml -OutputFile TestResults.xml
            
            if ($testResults.FailedCount -gt 0) {
              Write-Error "Tests failed: $($testResults.FailedCount) failures"
              exit 1
            }
          } else {
            Write-Warning "No test files found in Tests/ folder"
          }
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: pester-results-${{ matrix.powershell-version }}
          path: TestResults.xml

  code-analysis:
    name: Code Analysis
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up PowerShell
        uses: actions/setup-pwsh@v2
        with:
          pwsh-version: latest
      
      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -SkipPublisherCheck
      
      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          $analyzerResults = Invoke-ScriptAnalyzer -Path 'Modules' -Recurse -ExcludeRule PSUseApprovedVerbs | 
            Where-Object { $_.Severity -in @('Error', 'Warning') }
          
          if ($analyzerResults) {
            $analyzerResults | Format-Table -AutoSize
            Write-Error "PSScriptAnalyzer found issues"
            exit 1
          } else {
            Write-Host "âœ“ No code analysis issues found"
          }
      
      - name: Validate Module Manifests
        shell: pwsh
        run: |
          $manifests = Get-ChildItem -Path 'Modules' -Recurse -Filter '*.psd1'
          $failCount = 0
          
          foreach ($manifest in $manifests) {
            try {
              Test-ModuleManifest -Path $manifest.FullName -ErrorAction Stop | Out-Null
              Write-Host "âœ“ Valid: $($manifest.Name)"
            }
            catch {
              Write-Error "âœ— Invalid: $($manifest.Name) - $_"
              $failCount++
            }
          }
          
          if ($failCount -gt 0) {
            exit 1
          }

  security-scan:
    name: Security Scan
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up PowerShell
        uses: actions/setup-pwsh@v2
        with:
          pwsh-version: latest
      
      - name: Check for Hardcoded Credentials
        shell: pwsh
        run: |
          $patterns = @(
            'password\s*=\s*["''][^"'']+["'']',
            'api[_-]?key\s*=\s*["''][^"'']+["'']',
            'secret\s*=\s*["''][^"'']+["'']'
          )
          
          $issues = 0
          $files = Get-ChildItem -Path 'Modules' -Recurse -Include '*.ps1', '*.psm1'
          
          foreach ($pattern in $patterns) {
            $matches = Select-String -Path $files -Pattern $pattern -List
            if ($matches) {
              Write-Warning "Potential hardcoded credential found in: $($matches.Path)"
              $issues++
            }
          }
          
          if ($issues -gt 0) {
            Write-Error "Security issues found"
            exit 1
          } else {
            Write-Host "âœ“ No hardcoded credentials detected"
          }

  build-module:
    name: Build Modules
    needs: [pester-test, code-analysis, security-scan]
    runs-on: windows-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up PowerShell
        uses: actions/setup-pwsh@v2
        with:
          pwsh-version: latest
      
      - name: Build Modules
        shell: pwsh
        run: |
          # Create build output directory
          $buildPath = Join-Path $PWD '_Build'
          New-Item -ItemType Directory -Path $buildPath -Force | Out-Null
          
          # Copy all SophosFirewall modules to build directory
          $modules = Get-ChildItem -Path 'Modules' -Recurse -Filter '*.psd1'
          
          foreach ($module in $modules) {
            $moduleDir = $module.Directory.FullName
            $moduleName = $module.BaseName
            $destDir = Join-Path $buildPath $moduleName
            
            Copy-Item -Path $moduleDir -Destination $destDir -Recurse -Force
            Write-Host "ðŸ“¦ Built: $moduleName"
          }
          
          Write-Host "âœ“ Build complete: $buildPath"
      
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: sophos-firewall-modules
          path: _Build/
          retention-days: 30

  documentation:
    name: Documentation Check
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check Module Documentation
        shell: pwsh
        run: |
          $missingDocs = @()
          $modules = Get-ChildItem -Path 'Modules' -Directory | 
            Where-Object { $_.Name -like 'SophosFirewall.*' }
          
          foreach ($module in $modules) {
            $hasReadme = Test-Path -Path (Join-Path $module.FullName 'README.md')
            
            if (-not $hasReadme) {
              $missingDocs += $module.Name
            }
          }
          
          if ($missingDocs) {
            Write-Warning "Missing documentation for: $($missingDocs -join ', ')"
            # Don't fail build, just warn for now
            # exit 1
          } else {
            Write-Host "âœ“ All modules have documentation"
          }

  summary:
    name: Test Summary
    if: always()
    needs: [pester-test, code-analysis, security-scan]
    runs-on: windows-latest
    
    steps:
      - name: Create Job Summary
        run: |
          echo "# ðŸ§ª Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Pester Tests**: ${{ needs.pester-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Code Analysis**: ${{ needs.code-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Scan**: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [Action Logs]({{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details." >> $GITHUB_STEP_SUMMARY
