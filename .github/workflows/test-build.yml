name: Test & Build

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Modules/**'
      - 'Tests/**'
      - '.github/workflows/**'
      - '*.ps1'
      - '*.md'
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  pester-test:
    name: Pester Tests (PowerShell ${{ matrix.shell }})
    runs-on: windows-latest
    
    strategy:
      matrix:
        include:
          - shell: 'powershell'
            name: '5.1'
          - shell: 'pwsh'
            name: '7.x'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Pester module
        shell: pwsh
        run: |
          Install-Module -Name Pester -MinimumVersion 5.0 -Force -SkipPublisherCheck -Scope CurrentUser
      
      - name: Run Pester Tests
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Continue'
          
          # Add Modules directory to PSModulePath for test file imports
          $modulePath = Join-Path $PWD 'Modules'
          $env:PSModulePath = "$modulePath;$env:PSModulePath"
          Write-Host "Added to PSModulePath: $modulePath"
          
          # Find test files in the Tests directory
          $testFiles = Get-ChildItem -Path 'Tests' -Recurse -Filter '*.Tests.ps1' -ErrorAction SilentlyContinue
          
          if ($testFiles.Count -eq 0) {
            Write-Warning "No test files found in Tests/ folder"
            exit 0
          }
          
          Write-Host "Found $($testFiles.Count) test file(s)"
          
          try {
            # Use Pester 5 configuration instead of legacy parameters
            $pesterConfig = New-PesterConfiguration
            $pesterConfig.Run.Path = $testFiles.FullName
            $pesterConfig.Run.PassThru = $true
            $pesterConfig.TestResult.Enabled = $true
            $pesterConfig.TestResult.OutputFormat = 'NUnitXml'
            $pesterConfig.TestResult.OutputPath = 'TestResults.xml'
            
            $testResults = Invoke-Pester -Configuration $pesterConfig
            
            Write-Host "Test Results: Passed=$($testResults.PassedCount), Failed=$($testResults.FailedCount)"
            
            if ($testResults.FailedCount -gt 0) {
              Write-Error "Tests failed: $($testResults.FailedCount) failures"
              exit 1
            }
          }
          catch {
            Write-Error "Pester execution failed: $_"
            exit 1
          }
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pester-results-ps${{ matrix.name }}
          path: TestResults.xml

  code-analysis:
    name: Code Analysis
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -SkipPublisherCheck -Scope CurrentUser
          Import-Module PSScriptAnalyzer -Force
      
      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          try {
            # Run full analysis and show all results
            $allResults = Invoke-ScriptAnalyzer -Path 'Modules' -Recurse -ExcludeRule PSUseApprovedVerbs -ErrorAction Stop
            
            # Separate errors from warnings
            $errors = $allResults | Where-Object { $_.Severity -eq 'Error' }
            $warnings = $allResults | Where-Object { $_.Severity -eq 'Warning' }
            
            # Display all findings
            if ($allResults) {
              Write-Host "`n=== PSScriptAnalyzer Results ===" -ForegroundColor Cyan
              $allResults | Format-Table -AutoSize
              Write-Host "`nSummary: $($errors.Count) Error(s), $($warnings.Count) Warning(s)" -ForegroundColor Cyan
            }
            
            # Only fail on errors (warnings are informational)
            if ($errors) {
              Write-Error "PSScriptAnalyzer found $($errors.Count) error(s)"
              exit 1
            } else {
              Write-Host "âœ“ No critical code analysis issues found" -ForegroundColor Green
              if ($warnings) {
                Write-Host "  â„¹ $($warnings.Count) warning(s) detected (non-blocking)" -ForegroundColor Yellow
              }
            }
          }
          catch {
            Write-Error "PSScriptAnalyzer execution failed: $_"
            exit 1
          }
      
      - name: Validate Module Manifests
        shell: pwsh
        run: |
          # Add Modules directory to PSModulePath so dependencies can be resolved
          $modulesPath = Join-Path $PWD 'Modules'
          $env:PSModulePath = "$modulesPath$([System.IO.Path]::PathSeparator)$env:PSModulePath"
          
          Write-Host "Module search paths:" -ForegroundColor Cyan
          $env:PSModulePath -split [System.IO.Path]::PathSeparator | ForEach-Object { Write-Host "  - $_" }
          
          $manifests = Get-ChildItem -Path 'Modules' -Recurse -Filter '*.psd1'
          $failCount = 0
          
          foreach ($manifest in $manifests) {
            try {
              $testResult = Test-ModuleManifest -Path $manifest.FullName -ErrorAction Stop
              Write-Host "âœ“ Valid: $($manifest.Name) (v$($testResult.Version))" -ForegroundColor Green
            }
            catch {
              Write-Error "âœ— Invalid: $($manifest.Name) - $_"
              $failCount++
            }
          }
          
          if ($failCount -gt 0) {
            exit 1
          }

  security-scan:
    name: Security Scan
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Scan for Hardcoded Credentials
        shell: pwsh
        run: |
          $patterns = @(
            'pi[_-]?key\s*=\s*["''][^"'']+["'']',
            'secret\s*=\s*["''][^"'']+["'']'
          )
          
          $issues = 0
          $files = Get-ChildItem -Path 'Modules' -Recurse -Include '*.ps1', '*.psm1'
          
          foreach ($pattern in $patterns) {
            $matches = Select-String -Path $files -Pattern $pattern -List
            if ($matches) {
              Write-Warning "Potential hardcoded credential found in: $($matches.Path)"
              $issues++
            }
          }
          
          if ($issues -gt 0) {
            Write-Error "Security issues found"
            exit 1
          } else {
            Write-Host "âœ“ No hardcoded credentials detected"
          }

  build-module:
    name: Build Modules
    needs: [pester-test, code-analysis, security-scan]
    runs-on: windows-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build Modules
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path $buildPath -Force | Out-Null
          
          # Copy all SophosFirewall modules to build directory
          $modules = Get-ChildItem -Path 'Modules' -Recurse -Filter '*.psd1'
          
          foreach ($module in $modules) {
            $moduleDir = $module.Directory.FullName
            $moduleName = $module.BaseName
            $destDir = Join-Path $buildPath $moduleName
            
            Copy-Item -Path $moduleDir -Destination $destDir -Recurse -Force
            Write-Host "ðŸ“¦ Built: $moduleName"
          }
          
          Write-Host "âœ“ Build complete: $buildPath"
      
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sophos-firewall-modules
          path: _Build/
          retention-days: 30

  documentation:
    name: Documentation Check
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check Module Documentation
        shell: pwsh
        run: |
          $missingDocs = @()
          $modules = Get-ChildItem -Path 'Modules' -Directory | 
            Where-Object { $_.Name -like 'SophosFirewall.*' }
          
          foreach ($module in $modules) {
            $hasReadme = Test-Path -Path (Join-Path $module.FullName 'README.md')
            
            if (-not $hasReadme) {
              $missingDocs += $module.Name
            }
          }
          
          if ($missingDocs) {
            Write-Warning "Missing documentation for: $($missingDocs -join ', ')"
            # Don't fail build, just warn for now
            # exit 1
          } else {
            Write-Host "âœ“ All modules have documentation"
          }

  summary:
    name: Test Summary
    if: always()
    needs: [pester-test, code-analysis, security-scan]
    runs-on: windows-latest
    
    steps:
      - name: Create Job Summary
        run: |
          echo "# ðŸ§ª Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Pester Tests**: ${{ needs.pester-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Code Analysis**: ${{ needs.code-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Scan**: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [Action Logs]({{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details." >> $GITHUB_STEP_SUMMARY
